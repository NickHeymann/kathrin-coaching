<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CMS Editor">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2C4A47">
    <!-- CSP entfernt - iframe srcdoc erbt Parent CSP und blockiert Website-Ressourcen -->
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" href="../wp-content/uploads/2025/01/Kathrin_Stahl_Logo_RGB_gold.png">
    <title>CMS Editor v2.0 - Kathrin Stahl</title>
    <link rel="stylesheet" href="css/editor.css">

    <!-- Modern UI Styles (Glassmorphism) -->
    <link rel="stylesheet" href="../css/editor-modern/index.css">
</head>
<body class="modern">
    <!-- Setup Screen -->
    <div class="setup-screen" id="setupScreen">
        <div class="setup-card">
            <h1>Website Editor einrichten</h1>
            <p>Um Ã„nderungen automatisch zu speichern, benÃ¶tigst du einen GitHub-Zugang.</p>
            <input type="password" class="setup-input" id="tokenInput" placeholder="GitHub Token eingeben...">
            <button class="setup-btn" id="setupBtn">Editor starten</button>
            <details class="setup-help">
                <summary>Wie bekomme ich einen Token?</summary>
                <div class="setup-help-content">
                    <ol>
                        <li>Gehe zu <a href="https://github.com/settings/tokens/new" target="_blank">github.com/settings/tokens/new</a></li>
                        <li>Melde dich mit deinem GitHub-Konto an</li>
                        <li>Gib einen Namen ein, z.B. <code>Website Editor</code></li>
                        <li>WÃ¤hle bei "Expiration" einen langen Zeitraum</li>
                        <li>Aktiviere die Checkbox <code>repo</code></li>
                        <li>Klicke auf "Generate token"</li>
                        <li>Kopiere den Token und fÃ¼ge ihn hier ein</li>
                    </ol>
                    <p style="margin-top:1rem;"><strong>Hinweis:</strong> Der Token wird nur in deinem Browser gespeichert.</p>
                </div>
            </details>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar modern">
        <div class="toolbar-left">
            <button class="mobile-menu-btn" data-action="openSidebar" data-sidebar="versionsSidebar" aria-label="MenÃ¼ Ã¶ffnen">â˜°</button>
            <div class="toolbar-logo">Editor</div>
            <div class="toolbar-mode-switch">
                <a href="../cms/" class="mode-btn active">Seiten</a>
                <a href="../blog-editor-modular.html" class="mode-btn">Blog</a>
                <a href="../analytics.html" class="mode-btn" title="Analytics Dashboard">Analytics</a>
                <a href="docs.html" class="mode-btn" title="Dokumentation">ğŸ“š Docs</a>
            </div>
            <select id="pageSelect">
                <option value="">Seite wÃ¤hlen...</option>
                <optgroup label="Startseite">
                    <option value="index.html">Startseite</option>
                </optgroup>
                <optgroup label="Ãœber mich">
                    <option value="kathrin.html">Ãœber mich</option>
                </optgroup>
                <optgroup label="Portugal">
                    <option value="paar-retreat.html">Paar-Retreat</option>
                    <option value="pferdegestuetztes-coaching.html">PferdegestÃ¼tztes Coaching</option>
                    <option value="casinha.html">Casinha (Unterkunft)</option>
                </optgroup>
                <optgroup label="Selbsttests">
                    <option value="quiz-hochsensibel.html">HochsensibilitÃ¤t</option>
                    <option value="quiz-hochbegabt.html">Hochbegabung</option>
                    <option value="quiz-beziehung.html">Beziehung</option>
                    <option value="quiz-lebenskrise.html">Lebenskrise</option>
                    <option value="quiz-midlife.html">Midlife</option>
                    <option value="quiz-paar-kompass.html">Paar-Kompass</option>
                </optgroup>
                <optgroup label="Rechtliches">
                    <option value="impressum.html">Impressum</option>
                    <option value="datenschutzerklaerung.html">Datenschutz</option>
                </optgroup>
            </select>
        </div>
        <div class="toolbar-center">
            <div class="autosave-indicator">
                <div class="autosave-dot" id="autosaveDot"></div>
                <span id="autosaveText">Autosave aktiv</span>
            </div>
            <span class="status-badge status-saved" id="statusBadge">Gespeichert</span>
        </div>
        <div class="toolbar-right">
            <div class="feedback-dropdown">
                <button class="btn btn-ghost dropdown-trigger" data-action="CMS.toggleFeedbackDropdown">
                    ğŸ’¬ Feedback <span class="dropdown-arrow">â–¾</span>
                </button>
                <div class="dropdown-menu" id="feedbackDropdown">
                    <button class="dropdown-item" >
                        ğŸ¥ Video aufnehmen
                    </button>
                    <button class="dropdown-item" >
                        ğŸ“ Notizen
                    </button>
                </div>
            </div>
            <button class="btn btn-ghost" data-action="CMS.forceReload" data-tooltip="Seite neu laden" data-shortcut="âŒ˜R">Neu laden</button>
            <button class="btn btn-ghost" data-action="CMS.showVersions" data-tooltip="Versionsverlauf anzeigen">Versionen</button>
            <button class="btn btn-ghost" data-action="CMS.undo" data-tooltip="Letzte Ã„nderung rÃ¼ckgÃ¤ngig" data-shortcut="âŒ˜Z">RÃ¼ckgÃ¤ngig</button>
            <button class="btn btn-primary" data-action="CMS.saveNow" data-tooltip="Ã„nderungen jetzt speichern" data-shortcut="âŒ˜S">Jetzt speichern</button>
            <button class="btn btn-ghost btn-logout" data-action="CMS.logout" data-tooltip="Vom Editor abmelden">Abmelden</button>
        </div>
    </div>

    <!-- Sidebars -->
    <div class="sidebar" id="versionsSidebar">
        <button class="sidebar-close" data-action="closeSidebar" data-sidebar="versionsSidebar">&times;</button>
        <div class="sidebar-section">
            <h3>ğŸ“‹ Aktuelle Ã„nderungen</h3>
            <div id="changesList"><p style="color:#999;font-size:0.85rem;">Noch keine Ã„nderungen</p></div>
        </div>
        <div class="sidebar-section">
            <h3>ğŸ• Letzte Versionen</h3>
            <div class="version-list" id="versionList"><p style="color:#999;font-size:0.85rem;">Wird geladen...</p></div>
        </div>
        <div class="sidebar-section">
            <h3>â„¹ï¸ Info</h3>
            <p style="font-size:0.8rem;color:#666;line-height:1.5;">
                Ã„nderungen werden automatisch alle 30 Sekunden gespeichert.<br>
                <strong>Laden:</strong> Live-Website (main)<br>
                <strong>Speichern:</strong> Entwurfs-Branch (kathrin-edits)
            </p>
        </div>
    </div>

    <div class="sidebar" id="notesSidebar">
        <button class="sidebar-close" data-action="closeSidebar" data-sidebar="notesSidebar">&times;</button>
        <div class="sidebar-section" style="padding-bottom:0.5rem;">
            <h3 style="margin-bottom:0.5rem;">ğŸ“ Notizen</h3>
            <div style="display:flex;gap:0.5rem;margin-bottom:0.75rem;">
                <button class="btn btn-primary" style="flex:1;font-size:0.75rem;padding:0.3rem;" data-action="filterNotes" data-filter="current" id="notesFilterCurrent">Diese Seite</button>
                <button class="btn btn-ghost" style="flex:1;font-size:0.75rem;padding:0.3rem;" data-action="filterNotes" data-filter="all" id="notesFilterAll">Alle Seiten</button>
            </div>
        </div>
        <div id="notesListContainer" style="padding:0 1rem 1rem;"><p style="color:#999;font-size:0.85rem;">Noch keine Notizen</p></div>
        <div style="padding:1rem;border-top:1px solid #ddd;">
            <button class="btn btn-primary" style="width:100%;" data-action="CMS.createStickyNote">+ Neue Notiz</button>
        </div>
    </div>

    <!-- Start Screen -->
    <div class="start-screen" id="startScreen">
        <h2>Willkommen!</h2>
        <p>WÃ¤hle oben eine Seite aus, um mit dem Bearbeiten zu beginnen.</p>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Seite wird geladen...</div>
    </div>

    <!-- Main Frame -->
    <iframe id="siteFrame" class="website-frame"></iframe>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Offline Banner -->
    <div class="offline-banner" id="offlineBanner">
        Du bist offline. Ã„nderungen werden lokal gespeichert und spÃ¤ter synchronisiert.
    </div>

    <!-- Modals -->
    <div class="modal-bg modern" id="imgModal">
        <div class="modal modern">
            <h3>Bild ersetzen</h3>
            <div class="upload-zone" id="imgUploadZone">
                <div style="font-size:2rem;margin-bottom:0.5rem;">+</div>
                <p><strong>Klicken oder Bild hierher ziehen</strong></p>
                <input type="file" id="imgInput" accept="image/*">
            </div>
            <img id="imgPreview" class="preview-img" style="display:none;" loading="lazy">
            <div class="modal-btns">
                <button class="btn btn-cancel" data-action="CMS.closeImgModal">Abbrechen</button>
                <button class="btn btn-primary" id="imgConfirmBtn" data-action="CMS.confirmImg" disabled>Einsetzen</button>
            </div>
        </div>
    </div>

    <div class="modal-bg modern" id="videoModal">
        <div class="modal" style="max-width:500px;">
            <h3>Video Ã¤ndern</h3>
            <div style="display:flex;gap:0.5rem;margin-bottom:1rem;">
                <button class="btn btn-primary" id="videoTabUrl" data-action="switchVideoTab" data-tab="url" style="flex:1;">YouTube/Vimeo URL</button>
                <button class="btn btn-ghost" id="videoTabUpload" data-action="switchVideoTab" data-tab="upload" style="flex:1;">Video hochladen</button>
            </div>
            <div id="videoUrlSection">
                <p style="color:#666;margin-bottom:0.75rem;font-size:0.9rem;">YouTube oder Vimeo URL eingeben:</p>
                <input type="text" class="modal-input" id="videoInput" placeholder="https://youtube.com/watch?v=...">
            </div>
            <div id="videoUploadSection" style="display:none;">
                <div class="upload-zone" id="videoUploadZone">
                    <div style="font-size:2rem;margin-bottom:0.5rem;">ğŸ¬</div>
                    <p><strong>Video hierher ziehen</strong></p>
                    <p style="font-size:0.8rem;color:#999;">oder klicken zum AuswÃ¤hlen</p>
                    <p style="font-size:0.75rem;color:#999;margin-top:0.5rem;">MP4, WebM, MOV (max. 50 MB)</p>
                    <input type="file" id="videoFileInput" accept="video/mp4,video/webm,video/quicktime">
                </div>
                <video id="videoPreview" style="display:none;max-width:100%;max-height:150px;border-radius:8px;margin-top:1rem;" controls></video>
                <p id="videoFileName" style="display:none;font-size:0.85rem;color:#666;margin-top:0.5rem;"></p>
            </div>
            <div class="modal-btns">
                <button class="btn btn-cancel" data-action="CMS.closeVideoModal">Abbrechen</button>
                <button class="btn btn-primary" data-action="CMS.confirmVideo">Ã„ndern</button>
            </div>
        </div>
    </div>

    <!-- Background Image Modal -->
    <div class="modal-bg modern" id="bgModal">
        <div class="modal modern">
            <h3>ğŸ–¼ï¸ Hintergrundbild Ã¤ndern</h3>
            <div id="currentBgDisplay" class="current-bg-container"></div>
            <div class="upload-zone" id="bgUploadZone">
                <div style="font-size:2rem;margin-bottom:0.5rem;">+</div>
                <p><strong>Neues Hintergrundbild hochladen</strong></p>
                <p style="font-size:0.8rem;color:#999;">JPG, PNG oder WebP (max. 10 MB)</p>
                <input type="file" id="bgInput" accept="image/jpeg,image/png,image/webp">
            </div>
            <div id="bgPreview" class="bg-preview" style="display:none;"></div>
            <div class="modal-btns">
                <button class="btn btn-cancel" data-action="CMS.closeBgModal">Abbrechen</button>
                <button class="btn btn-primary" id="bgConfirmBtn" data-action="CMS.confirmBg" disabled>Einsetzen</button>
            </div>
        </div>
    </div>

    <!-- Section Color Modal -->
    <div class="modal-bg modern" id="colorModal">
        <div class="modal modern" style="max-width:450px;">
            <h3>ğŸ¨ Farben bearbeiten</h3>

            <!-- Gradient Editor (wird bei Gradienten angezeigt) -->
            <div id="gradientEditor" style="display:none;">
                <p style="color:#666;font-size:0.9rem;margin-bottom:0.75rem;">Gradient-Farben anpassen:</p>
                <div id="gradientPreview" class="gradient-preview"></div>
                <div id="gradientColorPickers" class="gradient-pickers"></div>
            </div>

            <!-- Einfacher Color Picker (fÃ¼r Nicht-Gradienten) -->
            <div id="simpleColorEditor">
                <div class="color-row">
                    <label>Hintergrundfarbe:</label>
                    <input type="color" id="sectionBgColor" value="#ffffff">
                </div>
            </div>

            <!-- Text Color -->
            <div class="color-row" style="margin-top:1rem;">
                <label>Textfarbe:</label>
                <input type="color" id="sectionTextColor" value="#000000">
            </div>

            <div class="modal-btns">
                <button class="btn btn-cancel" data-action="CMS.closeColorModal">Abbrechen</button>
                <button class="btn btn-primary" data-action="CMS.confirmSectionColor">Ãœbernehmen</button>
            </div>
        </div>
    </div>

    <!-- Popups -->
    <div class="format-toolbar" id="formatToolbar">
        <button class="format-btn" data-action="formatText" data-format="bold" title="Fett"><b>B</b></button>
        <button class="format-btn" data-action="formatText" data-format="italic" title="Kursiv"><i>I</i></button>
        <button class="format-btn" data-action="formatText" data-format="underline" title="Unterstrichen"><u>U</u></button>
        <button class="format-btn" data-action="CMS.showColorPicker" title="Farbe">ğŸ¨</button>
        <button class="format-btn" data-action="CMS.showEmojiPicker" title="Emoji">ğŸ˜Š</button>
    </div>

    <div class="color-picker-popup" id="colorPicker"></div>
    <div class="emoji-picker" id="emojiPicker"></div>
    <div class="element-history" id="elementHistory"></div>
    <div class="trash-panel" id="trashPanel"><h4>Papierkorb</h4><div id="trashList"></div></div>

    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" data-action="CMS.createNoteFromContext">
            <span>ğŸ“</span> Notiz erstellen
        </div>
        <div class="context-menu-item" data-action="background" onclick="CMS.editBackgroundFromContext()">
            <span>ğŸ–¼ï¸</span> Hintergrundbild Ã¤ndern
        </div>
        <div class="context-menu-item" data-action="history" onclick="CMS.showElementHistoryFromContext()">
            <span>ğŸ“œ</span> Ã„nderungsverlauf
        </div>
    </div>

    <!-- Recording Indicator -->
    <div class="recording-indicator" id="recordingIndicator">
        <div class="rec-dot"></div>
        <span id="recordingTime">00:00</span>
        <button class="rec-settings" data-action="CMS.showRecordSettings" title="Einstellungen">âš™ï¸</button>
        <button class="rec-stop" data-action="CMS.stopRecording">â¹ Stopp</button>
    </div>

    <!-- Recording Setup Modal -->
    <div class="modal-bg modern" id="recordModal">
        <div class="modal" style="max-width:450px;">
            <h3>ğŸ¥ Video-Feedback aufnehmen</h3>
            <p style="color:#666;margin-bottom:1rem;font-size:0.9rem;">
                Schau dir unten links deine Webcam-Vorschau an und prÃ¼fe, ob alles passt. Du kannst das Bild verschieben und skalieren!
            </p>

            <div class="record-options">
                <label class="record-option">
                    <input type="checkbox" id="recordScreen" checked>
                    <span>ğŸ–¥ï¸ Bildschirm aufnehmen</span>
                </label>
                <label class="record-option">
                    <input type="checkbox" id="recordMic" checked>
                    <span>ğŸ¤ Mikrofon (deine Stimme)</span>
                </label>
                <label class="record-option">
                    <input type="checkbox" id="recordCam" checked onchange="CMS.toggleWebcamPreview(this.checked)">
                    <span>ğŸ“· Webcam (Bild-in-Bild)</span>
                </label>
            </div>

            <!-- Webcam Einstellungen -->
            <details class="cam-settings-details" id="camSettingsDetails">
                <summary>âš™ï¸ Einstellungen</summary>
                <div class="cam-settings" id="camSettings">
                    <div class="settings-row">
                        <label>AuflÃ¶sung:</label>
                        <select id="camResolution" onchange="CMS.updatePreviewResolution()">
                            <option value="320x240">320x240 (klein)</option>
                            <option value="640x480" selected>640x480 (mittel)</option>
                            <option value="1280x720">1280x720 (HD)</option>
                        </select>
                    </div>
                    <div class="settings-row">
                        <label>Helligkeit:</label>
                        <input type="range" id="camBrightness" min="50" max="150" value="100">
                        <span id="brightnessValue">100%</span>
                    </div>
                    <div class="settings-row">
                        <label>Kontrast:</label>
                        <input type="range" id="camContrast" min="50" max="150" value="100">
                        <span id="contrastValue">100%</span>
                    </div>
                    <div class="settings-divider"></div>
                    <p style="font-size:0.75rem;color:#888;margin-bottom:0.5rem;">
                        ğŸ’¡ Ziehe an der Ecke unten rechts, um die BildgrÃ¶ÃŸe stufenlos anzupassen
                    </p>
                    <div class="settings-row">
                        <label>Hintergrund:</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="bgBlur" onchange="CMS.toggleBackgroundBlur(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="setting-label">Blur</span>
                    </div>
                    <div class="settings-row" id="blurStrengthRow" style="display:none;">
                        <label>Blur-StÃ¤rke:</label>
                        <input type="range" id="blurStrength" min="2" max="20" value="10">
                        <span id="blurStrengthValue">10px</span>
                    </div>
                </div>
            </details>

            <div class="modal-btns">
                <button class="btn btn-cancel" data-action="CMS.closeRecordModal">Abbrechen</button>
                <button class="btn btn-primary" data-action="CMS.startRecording">ğŸ”´ Aufnahme starten</button>
            </div>
        </div>
    </div>

    <!-- Webcam Picture-in-Picture Overlay -->
    <div class="webcam-pip" id="webcamPip">
        <video id="webcamVideo" autoplay muted playsinline></video>
        <div class="pip-resize-handle"></div>
    </div>

    <!-- Recording Preview Modal -->
    <div class="modal-bg modern" id="recordPreviewModal">
        <div class="modal" style="max-width:600px;">
            <h3>âœ… Aufnahme fertig!</h3>
            <video id="recordedVideo" controls style="width:100%;border-radius:8px;margin:1rem 0;background:#000;"></video>
            <p style="color:#666;font-size:0.85rem;margin-bottom:1rem;">
                Das Video wird zu GitHub hochgeladen und kann dort angesehen werden.
            </p>
            <div class="modal-btns">
                <button class="btn btn-cancel" data-action="CMS.discardRecording">Verwerfen</button>
                <button class="btn btn-primary" data-action="CMS.saveRecording">ğŸ’¾ Speichern & Senden</button>
            </div>
        </div>
    </div>

    <!-- External Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"
            integrity="sha384-vdScihEZCfbPnBQf+lc7LgXUdJVYyhC3yWHUW5C5P5GpHRqVnaM6HJELJxT6IqwM"
            crossorigin="anonymous"></script>

    <!-- Supabase Auth (optional) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"
            integrity="sha384-7pt7GFewRI7n6u5mojwHteymuhXHfh/cMTLG26Orj0a+jlzjtyrPegZmQXK3Jd5S"
            crossorigin="anonymous"></script>
    <script src="../admin/js/auth-check.js"></script>

    <!-- Shared UI Components -->
    <script src="../js/shared-ui.js"></script>

    <!-- Event Delegation (CSP-safe) -->
    <script src="js/events.js"></script>

    <!-- App Entry Point -->
    <script type="module" src="js/main.js"></script>
</body>
</html>
