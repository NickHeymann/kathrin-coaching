<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website bearbeiten - Glück über Zweifel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; background: #1a1a1a; }

        /* Toolbar */
        .toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: #2C4A47;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            z-index: 99999;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .toolbar-left, .toolbar-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .toolbar-logo {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .toolbar-logo span { opacity: 0.6; font-weight: 400; }

        select {
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
        }
        select option { background: #2C4A47; }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-weight: 500;
            transition: all 0.15s;
        }

        .btn-ghost {
            background: transparent;
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }
        .btn-ghost:hover { background: rgba(255,255,255,0.1); }

        .btn-primary {
            background: #D4A574;
            color: white;
        }
        .btn-primary:hover { background: #c49564; }

        .change-badge {
            background: #ff9800;
            padding: 0.25rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .change-badge.empty { background: rgba(255,255,255,0.2); }

        /* Website Frame */
        .website-frame {
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            bottom: 0;
            border: none;
            width: 100%;
            height: calc(100vh - 50px);
            background: white;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99998;
            transition: opacity 0.3s;
        }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2C4A47;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            margin-top: 1rem;
            color: #666;
            font-size: 0.95rem;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100000;
        }

        .toast {
            background: #333;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            animation: fadeIn 0.2s;
        }
        .toast.success { background: #4CAF50; }
        .toast.error { background: #f44336; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Modal */
        .modal-bg {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100001;
            align-items: center;
            justify-content: center;
        }
        .modal-bg.active { display: flex; }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal h3 {
            color: #2C4A47;
            margin-bottom: 1rem;
        }

        .upload-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .upload-zone:hover { border-color: #2C4A47; background: #f9f9f9; }
        .upload-zone.dragover { border-color: #D4A574; background: #fef9f5; }
        .upload-zone input { display: none; }

        .preview-img {
            max-width: 100%;
            max-height: 150px;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .modal-btns {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .modal-btns .btn { padding: 0.6rem 1.2rem; }
        .btn-cancel { background: #eee; color: #333; }
        .btn-cancel:hover { background: #ddd; }

        .video-input {
            width: 100%;
            padding: 0.6rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
        }

        /* Hilfe Modal */
        .help-content h4 { color: #2C4A47; margin: 1rem 0 0.5rem; }
        .help-content p { color: #555; line-height: 1.5; margin-bottom: 0.5rem; }
        .help-tip {
            background: #e8f5e9;
            border-left: 3px solid #4CAF50;
            padding: 0.75rem;
            margin: 1rem 0;
            border-radius: 0 6px 6px 0;
        }

        /* Start Screen */
        .start-screen {
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #f8f6f3 0%, #ece8e1 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99997;
        }
        .start-screen.hidden { display: none; }

        .start-screen h1 {
            font-size: 2rem;
            color: #2C4A47;
            margin-bottom: 0.5rem;
        }
        .start-screen p {
            color: #666;
            margin-bottom: 2rem;
        }
        .start-arrow {
            position: absolute;
            top: 20px;
            left: 180px;
            font-size: 3rem;
            color: #D4A574;
            animation: bounce 1s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <div class="toolbar-left">
            <div class="toolbar-logo">Website bearbeiten</div>
            <select id="pageSelect" onchange="loadPage(this.value)">
                <option value="">Seite wählen...</option>
                <optgroup label="Hauptseiten">
                    <option value="index.html">Startseite</option>
                    <option value="kathrin.html">Über Kathrin</option>
                    <option value="contact.html">Kontakt</option>
                </optgroup>
                <optgroup label="Coaching">
                    <option value="einzelbegleitung-sinnkrise-lebensumbruch.html">Einzelbegleitung</option>
                    <option value="paarbegleitung-beziehungskrise-neuanfang-kathrin-stahl.html">Paarbegleitung</option>
                    <option value="paar-retreat-in-portugal-beziehung-krise-kathrin-stahl.html">Paar-Retreat</option>
                </optgroup>
                <optgroup label="Portugal & Retreats">
                    <option value="retreats-in-portugal.html">Retreats Portugal</option>
                    <option value="retreat-portugal-alentejo-kathrin-stahl.html">Retreat Alentejo</option>
                    <option value="einzelretreat-portugal-alentejo-kathrin-stahl.html">Einzelretreat</option>
                    <option value="ruhiges-ferienhaus-im-alentejo-fuer-1-2-personen-kathrin-stahl.html">Ferienhaus</option>
                </optgroup>
                <optgroup label="Methoden">
                    <option value="systemische-aufstellungen.html">Systemische Aufstellungen</option>
                    <option value="heilen-im-schutz-der-pferde.html">Pferdegestütztes Coaching</option>
                    <option value="innere-fuehrung.html">Innere Führung</option>
                </optgroup>
                <optgroup label="Quiz & Tests">
                    <option value="quiz-paar-kompass.html">Paar-Kompass Quiz</option>
                    <option value="quiz-beziehung.html">Beziehungs-Quiz</option>
                    <option value="quiz-hochsensibel.html">Hochsensibel Quiz</option>
                    <option value="quiz-hochbegabt.html">Hochbegabt Quiz</option>
                    <option value="quiz-lebenskrise.html">Lebenskrise Quiz</option>
                    <option value="quiz-midlife.html">Midlife Quiz</option>
                </optgroup>
                <optgroup label="Themen">
                    <option value="hochbegabung-hochsensibilitat.html">Hochbegabung</option>
                    <option value="beziehungsprobleme.html">Beziehungsprobleme</option>
                    <option value="ehe-retten.html">Ehe retten</option>
                    <option value="gehen-oder-bleiben.html">Gehen oder Bleiben</option>
                </optgroup>
                <optgroup label="Blog & Medien">
                    <option value="blog.html">Blog</option>
                    <option value="glueck-ueber-zweifel-dein-podcast.html">Podcast</option>
                    <option value="love-letters.html">Love Letters</option>
                </optgroup>
            </select>
        </div>

        <span class="change-badge empty" id="changeBadge">Keine Änderungen</span>

        <div class="toolbar-right">
            <button class="btn btn-ghost" onclick="resetAll()">Zurücksetzen</button>
            <button class="btn btn-primary" onclick="saveChanges()">Speichern</button>
            <button class="btn btn-ghost" onclick="showHelp()" style="padding: 0.5rem 0.7rem;">?</button>
        </div>
    </div>

    <!-- Start Screen -->
    <div class="start-screen" id="startScreen">
        <div class="start-arrow">^</div>
        <h1>Willkommen!</h1>
        <p>Wähle oben eine Seite aus, um mit dem Bearbeiten zu beginnen.</p>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Seite wird geladen...</div>
    </div>

    <iframe id="siteFrame" class="website-frame"></iframe>

    <div class="toast-container" id="toasts"></div>

    <!-- Bild Upload Modal -->
    <div class="modal-bg" id="imgModal">
        <div class="modal">
            <h3>Bild ersetzen</h3>
            <div class="upload-zone" id="uploadZone">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">+</div>
                <p><strong>Klicken oder Bild hierher ziehen</strong></p>
                <input type="file" id="imgInput" accept="image/*">
            </div>
            <img id="imgPreview" class="preview-img" style="display:none;">
            <div class="modal-btns">
                <button class="btn btn-cancel" onclick="closeImgModal()">Abbrechen</button>
                <button class="btn btn-primary" id="imgConfirmBtn" onclick="confirmImg()" disabled>Einsetzen</button>
            </div>
        </div>
    </div>

    <!-- Video URL Modal -->
    <div class="modal-bg" id="videoModal">
        <div class="modal">
            <h3>Video ändern</h3>
            <p style="color:#666; margin-bottom:1rem;">YouTube oder Vimeo URL eingeben:</p>
            <input type="text" class="video-input" id="videoInput" placeholder="https://youtube.com/watch?v=...">
            <div class="modal-btns">
                <button class="btn btn-cancel" onclick="closeVideoModal()">Abbrechen</button>
                <button class="btn btn-primary" onclick="confirmVideo()">Ändern</button>
            </div>
        </div>
    </div>

    <!-- Hilfe Modal -->
    <div class="modal-bg" id="helpModal">
        <div class="modal help-content" style="max-width: 500px;">
            <h3>So funktioniert der Editor</h3>
            <h4>Texte bearbeiten</h4>
            <p>Klicke auf einen Text - er wird gelb markiert. Dann kannst du ihn ändern.</p>
            <h4>Bilder ersetzen</h4>
            <p>Klicke auf ein Bild - ein Fenster öffnet sich zum Hochladen eines neuen Bildes.</p>
            <h4>Videos ändern</h4>
            <p>Klicke auf ein Video - gib eine neue YouTube/Vimeo URL ein.</p>
            <div class="help-tip">
                <strong>Tipp:</strong> Elemente werden beim Darüberfahren farbig markiert.
            </div>
            <h4>Speichern</h4>
            <p>Klicke "Speichern" - Du bekommst eine Datei mit allen Änderungen für Nick.</p>
            <div class="modal-btns">
                <button class="btn btn-primary" onclick="closeHelp()">Verstanden!</button>
            </div>
        </div>
    </div>

    <script>
        let changes = [];
        let images = [];
        let currentImg = null;
        let currentVideo = null;
        let newImgData = null;
        let currentPage = null;
        let originalHTML = {};

        // Seite laden
        async function loadPage(page) {
            if (!page) return;

            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('loadingOverlay').classList.remove('hidden');

            currentPage = page;

            try {
                // HTML-Datei laden (aus gleichem Ordner)
                const response = await fetch(page);
                if (!response.ok) throw new Error('Seite nicht gefunden');

                let html = await response.text();

                // Original speichern
                originalHTML[page] = html;

                // Relative URLs zu absoluten machen für Bilder
                html = fixRelativeUrls(html);

                // Editor-Styles und Scripts einfügen
                html = injectEditorCode(html);

                // In iframe laden
                const frame = document.getElementById('siteFrame');
                frame.srcdoc = html;

                // Warten bis geladen
                frame.onload = () => {
                    setupFrameEditing(frame);
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    toast('Seite geladen - klicke auf Elemente zum Bearbeiten', 'success');
                };

            } catch(e) {
                console.error(e);
                document.getElementById('loadingOverlay').classList.add('hidden');
                toast('Fehler beim Laden: ' + e.message, 'error');
            }
        }

        // Relative URLs zu absoluten machen
        function fixRelativeUrls(html) {
            // Base URL für Assets
            const baseUrl = window.location.href.replace(/[^/]*$/, '');

            // CSS-Links
            html = html.replace(/href="([^"]+\.css)"/g, (match, url) => {
                if (url.startsWith('http') || url.startsWith('//')) return match;
                return `href="${baseUrl}${url}"`;
            });

            // JS-Scripts
            html = html.replace(/src="([^"]+\.js)"/g, (match, url) => {
                if (url.startsWith('http') || url.startsWith('//')) return match;
                return `src="${baseUrl}${url}"`;
            });

            // Bilder
            html = html.replace(/src="(images\/[^"]+)"/g, `src="${baseUrl}$1"`);
            html = html.replace(/url\(['"]?(images\/[^'")]+)['"]?\)/g, `url('${baseUrl}$1')`);

            return html;
        }

        // Editor-Code in HTML einfügen
        function injectEditorCode(html) {
            const editorStyles = `
                <style id="editor-styles">
                    /* Texte hover */
                    h1,h2,h3,h4,h5,h6,p,span,li,td,th,label,a,button {
                        transition: outline 0.15s, background 0.15s !important;
                    }
                    h1:hover,h2:hover,h3:hover,h4:hover,h5:hover,h6:hover,
                    p:hover,li:hover,label:hover,button:hover {
                        outline: 2px dashed #D4A574 !important;
                        outline-offset: 3px !important;
                        cursor: text !important;
                    }
                    [data-editing] {
                        background: #fff3cd !important;
                        outline: 2px solid #D4A574 !important;
                    }
                    [data-changed] {
                        background: #c8e6c9 !important;
                    }
                    /* Bilder hover */
                    img {
                        transition: outline 0.15s !important;
                        cursor: pointer !important;
                    }
                    img:hover {
                        outline: 3px solid #2196F3 !important;
                        outline-offset: 3px !important;
                    }
                    img[data-changed] {
                        outline: 3px solid #4CAF50 !important;
                    }
                    /* Videos hover */
                    .video-overlay {
                        position: absolute;
                        inset: 0;
                        cursor: pointer;
                        z-index: 10;
                        transition: background 0.15s;
                    }
                    .video-overlay:hover {
                        background: rgba(156, 39, 176, 0.2);
                    }
                    /* Links deaktivieren */
                    a { pointer-events: auto !important; }
                </style>
            `;

            // Vor </head> einfügen
            if (html.includes('</head>')) {
                html = html.replace('</head>', editorStyles + '</head>');
            } else {
                html = editorStyles + html;
            }

            return html;
        }

        // Frame-Editing einrichten
        function setupFrameEditing(frame) {
            const doc = frame.contentDocument;
            if (!doc) return;

            // Texte klickbar machen
            const textElements = doc.querySelectorAll('h1,h2,h3,h4,h5,h6,p,li,label,span,button');
            textElements.forEach((el, i) => {
                const txt = el.textContent.trim();
                // Nur Elemente mit Text und ohne Kinder-Bilder
                if (txt.length > 2 && !el.querySelector('img') && !el.closest('[data-no-edit]')) {
                    el.dataset.editIdx = i;
                    el.dataset.editOrig = txt;
                    el.style.cursor = 'text';

                    el.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        editText(el);
                    });
                }
            });

            // Bilder klickbar
            const images = doc.querySelectorAll('img');
            images.forEach((img, i) => {
                const src = img.src;
                if (src && !src.startsWith('data:') && !img.closest('[data-no-edit]')) {
                    img.dataset.editIdx = i;
                    img.dataset.editOrig = src;

                    img.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        editImg(img);
                    });
                }
            });

            // Videos (iframes)
            const iframes = doc.querySelectorAll('iframe');
            iframes.forEach((iframe, i) => {
                const src = iframe.src || '';
                if (src.includes('youtube') || src.includes('vimeo')) {
                    // Wrapper erstellen
                    const wrapper = doc.createElement('div');
                    wrapper.style.cssText = 'position:relative;display:inline-block;width:100%;';
                    iframe.parentNode.insertBefore(wrapper, iframe);
                    wrapper.appendChild(iframe);

                    // Overlay für Klick
                    const overlay = doc.createElement('div');
                    overlay.className = 'video-overlay';
                    overlay.dataset.editIdx = i;
                    overlay.dataset.editOrig = src;
                    wrapper.appendChild(overlay);

                    overlay.addEventListener('click', (e) => {
                        e.preventDefault();
                        editVideo(iframe, overlay);
                    });
                }
            });

            // Links deaktivieren
            doc.querySelectorAll('a').forEach(a => {
                a.addEventListener('click', (e) => {
                    // Nur verhindern wenn es ein echter Link ist
                    const href = a.getAttribute('href');
                    if (href && !href.startsWith('#') && !href.startsWith('javascript:')) {
                        e.preventDefault();
                    }
                });
            });
        }

        // Text bearbeiten
        let activeEl = null;
        function editText(el) {
            // Vorheriges Element zurücksetzen
            if (activeEl) {
                activeEl.removeAttribute('data-editing');
                activeEl.contentEditable = 'false';
            }

            activeEl = el;
            el.setAttribute('data-editing', 'true');
            el.contentEditable = 'true';
            el.focus();

            // Cursor ans Ende
            const doc = el.ownerDocument;
            const range = doc.createRange();
            range.selectNodeContents(el);
            range.collapse(false);
            const sel = doc.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);

            // Bei Blur speichern
            el.onblur = () => finishText(el);
            el.onkeydown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    el.blur();
                }
                if (e.key === 'Escape') {
                    el.textContent = el.dataset.editOrig;
                    el.blur();
                }
            };
        }

        function finishText(el) {
            el.removeAttribute('data-editing');
            el.contentEditable = 'false';

            const orig = el.dataset.editOrig;
            const now = el.textContent.trim();

            if (now !== orig) {
                el.setAttribute('data-changed', 'true');

                // Bestehende Änderung aktualisieren oder neue hinzufügen
                const existing = changes.find(c => c.idx === el.dataset.editIdx && c.type === 'text' && c.page === currentPage);
                if (existing) {
                    existing.newVal = now;
                } else {
                    changes.push({
                        type: 'text',
                        idx: el.dataset.editIdx,
                        tag: el.tagName,
                        selector: getSelector(el),
                        orig: orig,
                        newVal: now,
                        page: currentPage
                    });
                }
                updateBadge();
                toast('Text geändert', 'success');
            }
            activeEl = null;
        }

        // CSS-Selector für Element generieren
        function getSelector(el) {
            if (el.id) return '#' + el.id;
            if (el.className) {
                const classes = el.className.split(' ').filter(c => c).slice(0, 2).join('.');
                if (classes) return el.tagName.toLowerCase() + '.' + classes;
            }
            return el.tagName.toLowerCase();
        }

        // Bild bearbeiten
        function editImg(img) {
            currentImg = img;
            document.getElementById('imgModal').classList.add('active');
            document.getElementById('imgPreview').style.display = 'none';
            document.getElementById('imgConfirmBtn').disabled = true;
            newImgData = null;
        }

        function closeImgModal() {
            document.getElementById('imgModal').classList.remove('active');
            document.getElementById('imgInput').value = '';
            currentImg = null;
        }

        function confirmImg() {
            if (!currentImg || !newImgData) return;

            currentImg.src = newImgData.data;
            currentImg.setAttribute('data-changed', 'true');

            changes.push({
                type: 'image',
                idx: currentImg.dataset.editIdx,
                orig: currentImg.dataset.editOrig,
                newFile: newImgData.name,
                page: currentPage
            });
            images.push(newImgData);

            updateBadge();
            closeImgModal();
            toast('Bild ersetzt', 'success');
        }

        // Video bearbeiten
        function editVideo(iframe, overlay) {
            currentVideo = { iframe, overlay };
            document.getElementById('videoInput').value = overlay.dataset.editOrig;
            document.getElementById('videoModal').classList.add('active');
        }

        function closeVideoModal() {
            document.getElementById('videoModal').classList.remove('active');
            currentVideo = null;
        }

        function confirmVideo() {
            let url = document.getElementById('videoInput').value.trim();
            if (!url) return toast('Bitte URL eingeben', 'error');
            if (!url.includes('youtube') && !url.includes('vimeo')) {
                return toast('Nur YouTube oder Vimeo URLs', 'error');
            }

            // URL zu Embed-Format konvertieren
            if (url.includes('youtube.com/watch')) {
                const id = new URL(url).searchParams.get('v');
                url = `https://www.youtube.com/embed/${id}`;
            } else if (url.includes('youtu.be/')) {
                const id = url.split('youtu.be/')[1].split('?')[0];
                url = `https://www.youtube.com/embed/${id}`;
            }

            currentVideo.iframe.src = url;
            currentVideo.iframe.style.outline = '3px solid #4CAF50';

            changes.push({
                type: 'video',
                idx: currentVideo.overlay.dataset.editIdx,
                orig: currentVideo.overlay.dataset.editOrig,
                newVal: url,
                page: currentPage
            });

            updateBadge();
            closeVideoModal();
            toast('Video geändert', 'success');
        }

        // Badge aktualisieren
        function updateBadge() {
            const badge = document.getElementById('changeBadge');
            const n = changes.length;
            badge.textContent = n ? `${n} Änderung${n > 1 ? 'en' : ''}` : 'Keine Änderungen';
            badge.classList.toggle('empty', !n);
        }

        // Reset
        function resetAll() {
            if (!changes.length) return toast('Nichts zum Zurücksetzen');
            if (!confirm('Alle Änderungen verwerfen?')) return;
            changes = [];
            images = [];
            updateBadge();
            if (currentPage) loadPage(currentPage);
            toast('Zurückgesetzt', 'success');
        }

        // Speichern / Export
        function saveChanges() {
            if (!changes.length) return toast('Keine Änderungen zum Speichern', 'error');

            let txt = `WEBSITE-ÄNDERUNGEN\n${'='.repeat(50)}\nErstellt am: ${new Date().toLocaleString('de')}\n\n`;

            // Nach Seiten gruppieren
            const byPage = {};
            changes.forEach(c => {
                if (!byPage[c.page]) byPage[c.page] = [];
                byPage[c.page].push(c);
            });

            Object.entries(byPage).forEach(([page, list]) => {
                txt += `\nSEITE: ${page}\n${'-'.repeat(50)}\n`;

                list.forEach((c, i) => {
                    txt += `\n[${i + 1}] `;
                    if (c.type === 'text') {
                        txt += `TEXT (${c.tag})\n`;
                        txt += `    Vorher: "${c.orig.substring(0, 80)}${c.orig.length > 80 ? '...' : ''}"\n`;
                        txt += `    Nachher: "${c.newVal.substring(0, 80)}${c.newVal.length > 80 ? '...' : ''}"\n`;
                    } else if (c.type === 'image') {
                        txt += `BILD\n`;
                        txt += `    Altes Bild: ${c.orig.split('/').pop()}\n`;
                        txt += `    Neues Bild: ${c.newFile}\n`;
                    } else if (c.type === 'video') {
                        txt += `VIDEO\n`;
                        txt += `    Alte URL: ${c.orig}\n`;
                        txt += `    Neue URL: ${c.newVal}\n`;
                    }
                });
            });

            if (images.length) {
                txt += `\n\nNEUE BILDER (${images.length} Dateien)\n${'-'.repeat(50)}\n`;
                images.forEach((img, i) => {
                    txt += `  ${i + 1}. ${img.name}\n`;
                });
                txt += `\nDiese Bilder werden separat heruntergeladen.\n`;
            }

            txt += `\n${'='.repeat(50)}\nBitte diese Datei an Nick senden!\n`;

            // Änderungen als Textdatei downloaden
            const blob = new Blob([txt], { type: 'text/plain;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Website-Aenderungen-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();

            // Neue Bilder downloaden
            images.forEach((img, i) => {
                setTimeout(() => {
                    const link = document.createElement('a');
                    link.href = img.data;
                    link.download = img.name;
                    link.click();
                }, (i + 1) * 500);
            });

            toast('Gespeichert! Dateien werden heruntergeladen...', 'success');
        }

        // Hilfe
        function showHelp() {
            document.getElementById('helpModal').classList.add('active');
        }
        function closeHelp() {
            document.getElementById('helpModal').classList.remove('active');
        }

        // Toast
        function toast(msg, type = '') {
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.textContent = msg;
            document.getElementById('toasts').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // Upload Setup
        document.addEventListener('DOMContentLoaded', () => {
            const zone = document.getElementById('uploadZone');
            const input = document.getElementById('imgInput');

            zone.onclick = () => input.click();

            zone.ondragover = (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            };
            zone.ondragleave = () => zone.classList.remove('dragover');
            zone.ondrop = (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                handleFile(e.dataTransfer.files[0]);
            };

            input.onchange = (e) => handleFile(e.target.files[0]);

            // Hilfe beim ersten Mal
            if (!localStorage.getItem('editorSeenV2')) {
                setTimeout(showHelp, 500);
                localStorage.setItem('editorSeenV2', '1');
            }
        });

        function handleFile(file) {
            if (!file?.type.startsWith('image/')) return toast('Nur Bilddateien erlaubt', 'error');
            if (file.size > 10 * 1024 * 1024) return toast('Bild zu groß (max 10MB)', 'error');

            const reader = new FileReader();
            reader.onload = (e) => {
                newImgData = { data: e.target.result, name: file.name };
                document.getElementById('imgPreview').src = e.target.result;
                document.getElementById('imgPreview').style.display = 'block';
                document.getElementById('imgConfirmBtn').disabled = false;
            };
            reader.readAsDataURL(file);
        }

        // Warnung bei ungespeicherten Änderungen
        window.onbeforeunload = (e) => {
            if (changes.length) {
                e.preventDefault();
                return e.returnValue = 'Du hast ungespeicherte Änderungen!';
            }
        };
    </script>
</body>
</html>
