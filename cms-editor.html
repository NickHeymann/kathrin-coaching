<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website bearbeiten - Gl√ºck √ºber Zweifel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        /* Editor Toolbar - Fixed am oberen Rand */
        .editor-toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(135deg, #2C4A47 0%, #1a2e2c 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            z-index: 10000;
            box-shadow: 0 2px 20px rgba(0,0,0,0.3);
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .toolbar-logo {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toolbar-logo span {
            opacity: 0.7;
            font-weight: 400;
        }

        .page-selector {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 0.95rem;
            cursor: pointer;
            min-width: 200px;
        }

        .page-selector:focus {
            outline: none;
            border-color: #D4A574;
        }

        .page-selector option {
            background: #2C4A47;
            color: white;
        }

        .toolbar-center {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .btn-primary {
            background: #D4A574;
            color: white;
        }

        .btn-primary:hover {
            background: #c49564;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.15);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.25);
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-success:hover {
            background: #43a047;
        }

        .change-counter {
            background: #ff9800;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .change-counter.empty {
            background: rgba(255,255,255,0.2);
        }

        /* Hilfe-Button */
        .help-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: all 0.2s;
        }

        .help-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        /* Website Frame */
        .website-frame {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            border: none;
            width: 100%;
            height: calc(100vh - 60px);
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f8f6f3;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e0ddd8;
            border-top-color: #2C4A47;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: #666;
            font-size: 1.1rem;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10001;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: center;
        }

        .toast {
            background: #2C4A47;
            color: white;
            padding: 1rem 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: toastIn 0.3s ease;
            font-size: 0.95rem;
        }

        .toast.success { background: #4CAF50; }
        .toast.warning { background: #ff9800; }
        .toast.error { background: #f44336; }

        @keyframes toastIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Hilfe Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 10002;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal h2 {
            color: #2C4A47;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal h3 {
            color: #2C4A47;
            margin: 1.5rem 0 0.75rem;
            font-size: 1.1rem;
        }

        .modal p {
            color: #555;
            line-height: 1.6;
            margin-bottom: 0.75rem;
        }

        .modal ul {
            color: #555;
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .modal li {
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        .modal-close:hover {
            color: #333;
        }

        .tip-box {
            background: #e8f5e9;
            border-left: 4px solid #4CAF50;
            padding: 1rem;
            border-radius: 0 8px 8px 0;
            margin: 1rem 0;
        }

        .tip-box strong {
            color: #2e7d32;
        }

        /* Image Upload Modal */
        .upload-modal {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .upload-modal h3 {
            color: #2C4A47;
            margin-bottom: 1rem;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 1rem;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #2C4A47;
            background: #f8f6f3;
        }

        .upload-area-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .upload-area p {
            color: #666;
        }

        .upload-area input {
            display: none;
        }

        .upload-preview {
            margin-top: 1rem;
        }

        .upload-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .modal-actions .btn {
            padding: 0.75rem 1.5rem;
        }

        .btn-cancel {
            background: #eee;
            color: #333;
        }

        .btn-cancel:hover {
            background: #ddd;
        }
    </style>
</head>
<body>
    <!-- Editor Toolbar -->
    <div class="editor-toolbar">
        <div class="toolbar-left">
            <div class="toolbar-logo">
                ‚úèÔ∏è Editor <span>| Gl√ºck √ºber Zweifel</span>
            </div>
            <select class="page-selector" id="pageSelector" onchange="loadPage(this.value)">
                <option value="">‚Äî Seite w√§hlen ‚Äî</option>
                <option value="index.html">Startseite</option>
                <option value="kathrin.html">√úber Kathrin</option>
                <option value="blog.html">Blog</option>
                <option value="contact.html">Kontakt</option>
                <option value="einzelbegleitung-sinnkrise-lebensumbruch.html">Einzelbegleitung</option>
                <option value="paarbegleitung-beziehungskrise-neuanfang-kathrin-stahl.html">Paarbegleitung</option>
                <option value="paar-retreat.html">Paar-Retreat</option>
                <option value="retreats-in-portugal.html">Retreats Portugal</option>
                <option value="pferdegestuetztes-coaching.html">Pferdegest√ºtztes Coaching</option>
                <option value="systemische-aufstellungen.html">Systemische Aufstellungen</option>
                <option value="hochbegabung-hochsensibilitat.html">Hochbegabung</option>
                <option value="innere-fuehrung.html">Innere F√ºhrung</option>
                <option value="love-letters.html">Love Letters</option>
                <option value="glueck-ueber-zweifel-dein-podcast.html">Podcast</option>
                <option value="quiz-beziehung.html">Quiz: Beziehung</option>
                <option value="quiz-hochsensibel.html">Quiz: Hochsensibel</option>
                <option value="quiz-hochbegabt.html">Quiz: Hochbegabt</option>
                <option value="quiz-lebenskrise.html">Quiz: Lebenskrise</option>
                <option value="quiz-midlife.html">Quiz: Midlife</option>
            </select>
        </div>

        <div class="toolbar-center">
            <span class="change-counter empty" id="changeCounter">Keine √Ñnderungen</span>
        </div>

        <div class="toolbar-right">
            <button class="btn btn-secondary" onclick="resetChanges()">
                ‚Ü©Ô∏è Zur√ºcksetzen
            </button>
            <button class="btn btn-success" onclick="exportChanges()">
                üíæ √Ñnderungen speichern
            </button>
            <button class="help-btn" onclick="showHelp()">?</button>
        </div>
    </div>

    <!-- Website wird hier geladen -->
    <iframe id="websiteFrame" class="website-frame" src="about:blank"></iframe>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">W√§hle oben eine Seite aus...</div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Hilfe Modal -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal" style="position: relative;">
            <button class="modal-close" onclick="closeHelp()">√ó</button>
            <h2>‚úèÔ∏è So bearbeitest du die Website</h2>

            <h3>üìù Texte √§ndern</h3>
            <p>Klicke einfach auf einen Text, den du √§ndern m√∂chtest. Er wird gelb markiert und du kannst direkt lostippen.</p>

            <h3>üñºÔ∏è Bilder austauschen</h3>
            <p>Klicke auf ein Bild, das du ersetzen m√∂chtest. Es √∂ffnet sich ein Dialog, in dem du ein neues Bild hochladen kannst.</p>

            <h3>üé¨ Videos √§ndern</h3>
            <p>Klicke auf ein Video. Du kannst dann eine neue YouTube- oder Vimeo-URL eingeben.</p>

            <div class="tip-box">
                <strong>üí° Tipp:</strong> Bearbeitbare Elemente werden beim √úberfahren mit der Maus leicht hervorgehoben.
            </div>

            <h3>üíæ √Ñnderungen speichern</h3>
            <p>Wenn du fertig bist, klicke auf "√Ñnderungen speichern". Du erh√§ltst dann Dateien, die du an Nick schicken kannst.</p>

            <ul>
                <li>Eine <strong>Textdatei</strong> mit allen √Ñnderungen als √úbersicht</li>
                <li>Alle <strong>neuen Bilder</strong> werden heruntergeladen</li>
            </ul>

            <div class="modal-actions">
                <button class="btn btn-primary" onclick="closeHelp()">Verstanden!</button>
            </div>
        </div>
    </div>

    <!-- Image Upload Modal -->
    <div class="modal-overlay" id="imageUploadModal">
        <div class="upload-modal">
            <h3>üñºÔ∏è Neues Bild ausw√§hlen</h3>
            <p style="color: #666; margin-bottom: 1rem;">W√§hle ein Bild von deinem Computer:</p>

            <div class="upload-area" id="uploadArea">
                <div class="upload-area-icon">üì∑</div>
                <p><strong>Klicke hier oder ziehe ein Bild hierher</strong></p>
                <p style="font-size: 0.85rem;">JPG, PNG, WebP</p>
                <input type="file" id="imageFileInput" accept="image/*">
            </div>

            <div class="upload-preview" id="uploadPreview" style="display: none;">
                <p style="color: #666; margin-bottom: 0.5rem;">Vorschau:</p>
                <img id="previewImage" src="" alt="Vorschau">
            </div>

            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeImageUpload()">Abbrechen</button>
                <button class="btn btn-primary" id="confirmImageBtn" onclick="confirmImageChange()" disabled>Bild einsetzen</button>
            </div>
        </div>
    </div>

    <!-- Video URL Modal -->
    <div class="modal-overlay" id="videoUrlModal">
        <div class="upload-modal">
            <h3>üé¨ Video-URL √§ndern</h3>
            <p style="color: #666; margin-bottom: 1rem;">Gib die neue YouTube- oder Vimeo-URL ein:</p>

            <input type="text" id="videoUrlInput" placeholder="https://www.youtube.com/watch?v=..."
                   style="width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">

            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeVideoModal()">Abbrechen</button>
                <button class="btn btn-primary" onclick="confirmVideoChange()">Video √§ndern</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // KONFIGURATION
        // ============================================
        const CONFIG = {
            baseUrl: 'https://nickheymann.github.io/kathrin-coaching/'
        };

        // State
        const state = {
            currentPage: null,
            changes: [],
            uploadedImages: [],
            currentEditingElement: null,
            currentEditingImage: null,
            currentEditingVideo: null,
            newImageData: null
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupUploadArea();

            // Zeige Hilfe beim ersten Besuch
            if (!localStorage.getItem('editorHelpSeen')) {
                setTimeout(() => {
                    showHelp();
                    localStorage.setItem('editorHelpSeen', 'true');
                }, 500);
            }
        });

        // Seite laden
        async function loadPage(page) {
            if (!page) return;

            state.currentPage = page;
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = loadingOverlay.querySelector('.loading-text');

            loadingOverlay.classList.remove('hidden');
            loadingText.textContent = 'Lade Seite...';

            try {
                const response = await fetch(CONFIG.baseUrl + page);
                if (!response.ok) throw new Error('Seite nicht gefunden');

                let html = await response.text();

                // CSS und JS f√ºr Editor-Funktionalit√§t injizieren
                html = injectEditorStyles(html);

                const frame = document.getElementById('websiteFrame');
                frame.srcdoc = html;

                frame.onload = () => {
                    setupEditableElements(frame);
                    loadingOverlay.classList.add('hidden');
                    showToast('Seite geladen - klicke auf Elemente zum Bearbeiten', 'success');
                };

            } catch (error) {
                console.error(error);
                loadingText.textContent = 'Fehler beim Laden: ' + error.message;
                showToast('Fehler beim Laden der Seite', 'error');
            }
        }

        // Editor-Styles in die Seite injizieren
        function injectEditorStyles(html) {
            const editorStyles = `
                <style id="editor-styles">
                    /* Bearbeitbare Texte */
                    h1, h2, h3, h4, h5, h6, p, span, a, li, td, th, label, button {
                        cursor: text !important;
                        transition: outline 0.2s, background-color 0.2s !important;
                    }

                    h1:hover, h2:hover, h3:hover, h4:hover, h5:hover, h6:hover,
                    p:hover, span:hover, a:hover, li:hover, label:hover {
                        outline: 2px dashed #D4A574 !important;
                        outline-offset: 4px !important;
                    }

                    [data-editing="true"] {
                        background-color: #fff3cd !important;
                        outline: 3px solid #D4A574 !important;
                        outline-offset: 2px !important;
                    }

                    /* Bearbeitbare Bilder */
                    img {
                        cursor: pointer !important;
                        transition: outline 0.2s, opacity 0.2s !important;
                    }

                    img:hover {
                        outline: 3px solid #2196F3 !important;
                        outline-offset: 4px !important;
                    }

                    img[data-changed="true"] {
                        outline: 3px solid #4CAF50 !important;
                        outline-offset: 4px !important;
                    }

                    /* Bearbeitbare Videos/Iframes */
                    iframe {
                        cursor: pointer !important;
                        transition: outline 0.2s !important;
                    }

                    iframe:hover {
                        outline: 3px solid #9c27b0 !important;
                        outline-offset: 4px !important;
                    }

                    /* Ge√§nderte Texte markieren */
                    [data-changed="true"] {
                        background-color: #c8e6c9 !important;
                    }

                    /* Editor-Hinweis */
                    .editor-hint {
                        position: fixed;
                        bottom: 20px;
                        right: 20px;
                        background: #2C4A47;
                        color: white;
                        padding: 0.75rem 1.25rem;
                        border-radius: 8px;
                        font-size: 0.9rem;
                        z-index: 9999;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                    }
                </style>
            `;

            return html.replace('</head>', editorStyles + '</head>');
        }

        // Bearbeitbare Elemente einrichten
        function setupEditableElements(frame) {
            const doc = frame.contentDocument;

            // Hint hinzuf√ºgen
            const hint = doc.createElement('div');
            hint.className = 'editor-hint';
            hint.innerHTML = '‚úèÔ∏è Klicke auf Texte, Bilder oder Videos zum Bearbeiten';
            doc.body.appendChild(hint);

            // Nach 5 Sekunden ausblenden
            setTimeout(() => {
                hint.style.transition = 'opacity 0.5s';
                hint.style.opacity = '0';
                setTimeout(() => hint.remove(), 500);
            }, 5000);

            // Texte bearbeitbar machen
            const textElements = doc.querySelectorAll('h1, h2, h3, h4, h5, h6, p, span, li, td, th, label');
            textElements.forEach((el, index) => {
                const text = el.textContent.trim();
                if (text && text.length > 2 && !el.querySelector('img') && !el.closest('script') && !el.closest('style')) {
                    el.dataset.editorId = `text-${index}`;
                    el.dataset.originalText = text;

                    el.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        startTextEditing(el);
                    });
                }
            });

            // Bilder klickbar machen
            const images = doc.querySelectorAll('img');
            images.forEach((img, index) => {
                const src = img.getAttribute('src');
                if (src && !src.startsWith('data:')) {
                    img.dataset.editorId = `img-${index}`;
                    img.dataset.originalSrc = src;

                    img.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        startImageEditing(img);
                    });
                }
            });

            // Videos/Iframes klickbar machen
            const iframes = doc.querySelectorAll('iframe');
            iframes.forEach((iframe, index) => {
                const src = iframe.getAttribute('src') || '';
                if (src.includes('youtube') || src.includes('vimeo')) {
                    // Overlay f√ºr Iframe erstellen (da Iframes schwer zu klicken sind)
                    const wrapper = doc.createElement('div');
                    wrapper.style.cssText = 'position: relative; display: inline-block;';
                    iframe.parentNode.insertBefore(wrapper, iframe);
                    wrapper.appendChild(iframe);

                    const overlay = doc.createElement('div');
                    overlay.style.cssText = `
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        cursor: pointer;
                        z-index: 10;
                    `;
                    overlay.dataset.editorId = `video-${index}`;
                    overlay.dataset.originalSrc = src;
                    wrapper.appendChild(overlay);

                    overlay.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        startVideoEditing(iframe, overlay);
                    });
                }
            });

            // Links deaktivieren
            doc.querySelectorAll('a').forEach(a => {
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                });
            });
        }

        // Text-Bearbeitung starten
        function startTextEditing(el) {
            // Vorherige Bearbeitung beenden
            if (state.currentEditingElement) {
                state.currentEditingElement.removeAttribute('data-editing');
                state.currentEditingElement.contentEditable = 'false';
            }

            state.currentEditingElement = el;
            el.dataset.editing = 'true';
            el.contentEditable = 'true';
            el.focus();

            // Auswahl am Ende positionieren
            const range = el.ownerDocument.createRange();
            range.selectNodeContents(el);
            range.collapse(false);
            const sel = el.ownerDocument.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);

            // Bei Blur speichern
            el.addEventListener('blur', () => finishTextEditing(el), { once: true });

            // Bei Enter beenden
            el.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    el.blur();
                }
            });
        }

        // Text-Bearbeitung beenden
        function finishTextEditing(el) {
            el.removeAttribute('data-editing');
            el.contentEditable = 'false';

            const originalText = el.dataset.originalText;
            const newText = el.textContent.trim();

            if (newText !== originalText) {
                el.dataset.changed = 'true';

                // √Ñnderung speichern
                const existingChange = state.changes.find(c => c.id === el.dataset.editorId);
                if (existingChange) {
                    existingChange.newValue = newText;
                } else {
                    state.changes.push({
                        id: el.dataset.editorId,
                        type: 'text',
                        element: el.tagName.toLowerCase(),
                        originalValue: originalText,
                        newValue: newText,
                        page: state.currentPage
                    });
                }

                updateChangeCounter();
                showToast('Text ge√§ndert ‚úì', 'success');
            }

            state.currentEditingElement = null;
        }

        // Bild-Bearbeitung starten
        function startImageEditing(img) {
            state.currentEditingImage = img;
            document.getElementById('imageUploadModal').classList.add('active');
            document.getElementById('uploadPreview').style.display = 'none';
            document.getElementById('confirmImageBtn').disabled = true;
            state.newImageData = null;
        }

        // Video-Bearbeitung starten
        function startVideoEditing(iframe, overlay) {
            state.currentEditingVideo = { iframe, overlay };
            const currentSrc = overlay.dataset.originalSrc;
            document.getElementById('videoUrlInput').value = currentSrc;
            document.getElementById('videoUrlModal').classList.add('active');
        }

        // Upload-Area einrichten
        function setupUploadArea() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('imageFileInput');

            uploadArea.addEventListener('click', () => fileInput.click());

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleImageFile(e.dataTransfer.files[0]);
            });

            fileInput.addEventListener('change', (e) => {
                handleImageFile(e.target.files[0]);
            });
        }

        // Bild-Datei verarbeiten
        function handleImageFile(file) {
            if (!file || !file.type.startsWith('image/')) {
                showToast('Bitte w√§hle eine Bilddatei', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                state.newImageData = {
                    data: e.target.result,
                    name: file.name,
                    size: file.size,
                    type: file.type
                };

                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('uploadPreview').style.display = 'block';
                document.getElementById('confirmImageBtn').disabled = false;
            };
            reader.readAsDataURL(file);
        }

        // Bild-√Ñnderung best√§tigen
        function confirmImageChange() {
            if (!state.currentEditingImage || !state.newImageData) return;

            const img = state.currentEditingImage;
            const originalSrc = img.dataset.originalSrc;

            // Bild im Frame √§ndern
            img.src = state.newImageData.data;
            img.dataset.changed = 'true';

            // √Ñnderung speichern
            state.changes.push({
                id: img.dataset.editorId,
                type: 'image',
                originalValue: originalSrc,
                newValue: state.newImageData.name,
                imageData: state.newImageData.data,
                page: state.currentPage
            });

            state.uploadedImages.push(state.newImageData);

            updateChangeCounter();
            closeImageUpload();
            showToast('Bild ersetzt ‚úì', 'success');
        }

        // Bild-Upload Modal schlie√üen
        function closeImageUpload() {
            document.getElementById('imageUploadModal').classList.remove('active');
            document.getElementById('imageFileInput').value = '';
            state.currentEditingImage = null;
            state.newImageData = null;
        }

        // Video-√Ñnderung best√§tigen
        function confirmVideoChange() {
            const newUrl = document.getElementById('videoUrlInput').value.trim();

            if (!newUrl) {
                showToast('Bitte gib eine URL ein', 'error');
                return;
            }

            if (!newUrl.includes('youtube') && !newUrl.includes('vimeo')) {
                showToast('Nur YouTube und Vimeo werden unterst√ºtzt', 'error');
                return;
            }

            const { iframe, overlay } = state.currentEditingVideo;
            const originalSrc = overlay.dataset.originalSrc;

            // URL f√ºr Embed formatieren
            let embedUrl = newUrl;
            if (newUrl.includes('youtube.com/watch')) {
                const videoId = new URL(newUrl).searchParams.get('v');
                embedUrl = `https://www.youtube.com/embed/${videoId}`;
            } else if (newUrl.includes('youtu.be/')) {
                const videoId = newUrl.split('youtu.be/')[1].split('?')[0];
                embedUrl = `https://www.youtube.com/embed/${videoId}`;
            }

            // Video √§ndern
            iframe.src = embedUrl;
            iframe.style.outline = '3px solid #4CAF50';

            // √Ñnderung speichern
            state.changes.push({
                id: overlay.dataset.editorId,
                type: 'video',
                originalValue: originalSrc,
                newValue: embedUrl,
                page: state.currentPage
            });

            updateChangeCounter();
            closeVideoModal();
            showToast('Video ge√§ndert ‚úì', 'success');
        }

        // Video Modal schlie√üen
        function closeVideoModal() {
            document.getElementById('videoUrlModal').classList.remove('active');
            state.currentEditingVideo = null;
        }

        // √Ñnderungs-Counter aktualisieren
        function updateChangeCounter() {
            const counter = document.getElementById('changeCounter');
            const count = state.changes.length;

            if (count === 0) {
                counter.textContent = 'Keine √Ñnderungen';
                counter.classList.add('empty');
            } else {
                counter.textContent = `${count} √Ñnderung${count > 1 ? 'en' : ''}`;
                counter.classList.remove('empty');
            }
        }

        // √Ñnderungen zur√ºcksetzen
        function resetChanges() {
            if (state.changes.length === 0) {
                showToast('Keine √Ñnderungen zum Zur√ºcksetzen', 'warning');
                return;
            }

            if (confirm('Alle √Ñnderungen verwerfen?')) {
                state.changes = [];
                state.uploadedImages = [];
                updateChangeCounter();

                // Seite neu laden
                if (state.currentPage) {
                    loadPage(state.currentPage);
                }

                showToast('√Ñnderungen zur√ºckgesetzt', 'success');
            }
        }

        // √Ñnderungen exportieren
        function exportChanges() {
            if (state.changes.length === 0) {
                showToast('Keine √Ñnderungen zum Speichern', 'warning');
                return;
            }

            // Lesbare Zusammenfassung erstellen
            let summary = `WEBSITE-√ÑNDERUNGEN F√úR NICK
============================
Erstellt am: ${new Date().toLocaleString('de-DE')}
Anzahl √Ñnderungen: ${state.changes.length}

`;

            // Nach Seiten gruppieren
            const byPage = {};
            state.changes.forEach(change => {
                if (!byPage[change.page]) byPage[change.page] = [];
                byPage[change.page].push(change);
            });

            Object.entries(byPage).forEach(([page, changes]) => {
                summary += `\nüìÑ SEITE: ${page}\n`;
                summary += `${'‚îÄ'.repeat(40)}\n`;

                changes.forEach(change => {
                    if (change.type === 'text') {
                        summary += `\n‚úèÔ∏è TEXT GE√ÑNDERT (${change.element.toUpperCase()}):\n`;
                        summary += `   VORHER: "${change.originalValue.substring(0, 80)}${change.originalValue.length > 80 ? '...' : ''}"\n`;
                        summary += `   NACHHER: "${change.newValue.substring(0, 80)}${change.newValue.length > 80 ? '...' : ''}"\n`;
                    } else if (change.type === 'image') {
                        summary += `\nüñºÔ∏è BILD ERSETZT:\n`;
                        summary += `   ALTES BILD: ${change.originalValue.split('/').pop()}\n`;
                        summary += `   NEUES BILD: ${change.newValue}\n`;
                    } else if (change.type === 'video') {
                        summary += `\nüé¨ VIDEO GE√ÑNDERT:\n`;
                        summary += `   ALTE URL: ${change.originalValue}\n`;
                        summary += `   NEUE URL: ${change.newValue}\n`;
                    }
                });
            });

            if (state.uploadedImages.length > 0) {
                summary += `\n\nüì∑ NEUE BILDER (werden separat heruntergeladen):\n`;
                summary += `${'‚îÄ'.repeat(40)}\n`;
                state.uploadedImages.forEach(img => {
                    summary += `   - ${img.name}\n`;
                });
            }

            summary += `\n\n${'‚ïê'.repeat(40)}\n`;
            summary += `Bitte diese Datei + alle Bilder an Nick senden!\n`;

            // Textdatei herunterladen
            const blob = new Blob([summary], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Website-√Ñnderungen-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);

            // Bilder herunterladen
            if (state.uploadedImages.length > 0) {
                setTimeout(() => {
                    state.uploadedImages.forEach((img, i) => {
                        setTimeout(() => {
                            const link = document.createElement('a');
                            link.href = img.data;
                            link.download = img.name;
                            link.click();
                        }, i * 500);
                    });
                }, 1000);
            }

            showToast('√Ñnderungen gespeichert! Dateien werden heruntergeladen...', 'success');
        }

        // Hilfe anzeigen
        function showHelp() {
            document.getElementById('helpModal').classList.add('active');
        }

        // Hilfe schlie√üen
        function closeHelp() {
            document.getElementById('helpModal').classList.remove('active');
        }

        // Toast anzeigen
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Warnung vor Verlassen
        window.addEventListener('beforeunload', (e) => {
            if (state.changes.length > 0) {
                e.preventDefault();
                e.returnValue = 'Du hast ungespeicherte √Ñnderungen!';
            }
        });
    </script>
</body>
</html>
