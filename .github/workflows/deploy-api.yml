# Kathrin Coaching - API Deployment
# Automatisches Deployment bei Push auf main (server/ Ã„nderungen)
# Secrets werden automatisch aus GitHub Secrets bezogen

name: Deploy API to Hetzner

on:
  push:
    branches: [main]
    paths:
      - 'server/**'
      - '.github/workflows/deploy-api.yml'
  workflow_dispatch:  # Manuelles Triggern erlauben

env:
  SERVER_HOST: 91.99.177.238
  SERVER_USER: root
  APP_PATH: /opt/apps/kathrin-analytics

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Clone/Update Repository on Server
        run: |
          ssh -i ~/.ssh/deploy_key ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            set -e
            mkdir -p /opt/apps/kathrin-analytics
            cd /opt/apps/kathrin-analytics

            # Git Repository klonen oder updaten
            if [ -d ".git" ]; then
              echo "ðŸ“¥ Pulling latest changes..."
              git fetch origin main
              git reset --hard origin/main
            else
              echo "ðŸ“¦ Cleaning directory and cloning..."
              rm -rf /opt/apps/kathrin-analytics/* 2>/dev/null || true
              rm -rf /opt/apps/kathrin-analytics/.* 2>/dev/null || true
              git clone --depth 1 https://github.com/NickHeymann/kathrin-coaching.git .
            fi

            echo "âœ… Repository ready"
          ENDSSH

      - name: Create .env on Server
        run: |
          ssh -i ~/.ssh/deploy_key ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << ENVSSH
            cat > /opt/apps/kathrin-analytics/server/.env << 'ENVFILE'
# Kathrin Coaching - Server Environment
# Automatisch generiert von GitHub Actions

# === PostgreSQL ===
DB_PASSWORD=${{ secrets.KATHRIN_DB_PASSWORD }}

# === Umami Analytics ===
APP_SECRET=${{ secrets.KATHRIN_APP_SECRET }}

# === API Security ===
API_SECRET_TOKEN=${{ secrets.KATHRIN_API_SECRET }}

# === GitHub (fÃ¼r Auto-Publishing) ===
GITHUB_TOKEN=${{ secrets.KATHRIN_GITHUB_TOKEN }}

# === Groq AI (fÃ¼r Blog-Assistent) ===
GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}

# === Server ===
NODE_ENV=production
PORT=3001
ENVFILE
            chmod 600 /opt/apps/kathrin-analytics/server/.env
            echo "âœ… .env created"
          ENVSSH

      - name: Build and Start Containers
        run: |
          ssh -i ~/.ssh/deploy_key ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            set -e
            cd /opt/apps/kathrin-analytics/server

            # Container neu bauen und starten
            echo "ðŸ³ Building and starting containers..."
            docker compose -f docker-compose.production.yml down || true
            docker compose -f docker-compose.production.yml up -d --build

            # Alte Images aufrÃ¤umen
            docker image prune -f

            # Status anzeigen
            echo "ðŸ“Š Container Status:"
            docker ps --filter "name=kathrin" --format "table {{.Names}}\t{{.Status}}"

            echo "âœ… Containers started!"
          ENDSSH

      - name: Health Check
        run: |
          echo "â³ Waiting for services to start..."
          sleep 30

          # API Health Check
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://api-kathrin.91.99.177.238.nip.io/api/health || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… API is healthy! (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸ API returned HTTP $HTTP_CODE (may still be starting)"
          fi

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Analytics | https://analytics.91.99.177.238.nip.io |" >> $GITHUB_STEP_SUMMARY
          echo "| API | https://api-kathrin.91.99.177.238.nip.io |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
