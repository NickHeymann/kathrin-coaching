# Kathrin Coaching - API Deployment
# Automatisches Deployment bei Push auf main (server/ Ã„nderungen)
# Secrets werden automatisch aus GitHub Secrets bezogen

name: Deploy API to Hetzner

on:
  push:
    branches: [main]
    paths:
      - 'server/**'
      - '.github/workflows/deploy-api.yml'
  workflow_dispatch:  # Manuelles Triggern erlauben

env:
  SERVER_HOST: 91.99.177.238
  SERVER_USER: root
  APP_PATH: /opt/apps/kathrin-analytics

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Clone/Update Repository on Server
        run: |
          ssh -i ~/.ssh/deploy_key ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} 'set -e && mkdir -p /opt/apps/kathrin-analytics && cd /opt/apps/kathrin-analytics && if [ -d ".git" ]; then echo "Pulling latest changes..." && git fetch origin main && git reset --hard origin/main; else echo "Cleaning and cloning..." && rm -rf /opt/apps/kathrin-analytics/* 2>/dev/null || true && rm -rf /opt/apps/kathrin-analytics/.* 2>/dev/null || true && git clone --depth 1 https://github.com/NickHeymann/kathrin-coaching.git .; fi && echo "Repository ready"'

      - name: Create .env on Server
        run: |
          ssh -i ~/.ssh/deploy_key ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "cat > /opt/apps/kathrin-analytics/server/.env << 'EOF'
DB_PASSWORD=${{ secrets.KATHRIN_DB_PASSWORD }}
APP_SECRET=${{ secrets.KATHRIN_APP_SECRET }}
API_SECRET_TOKEN=${{ secrets.KATHRIN_API_SECRET }}
GITHUB_TOKEN=${{ secrets.KATHRIN_GITHUB_TOKEN }}
GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}
NODE_ENV=production
PORT=3001
EOF
chmod 600 /opt/apps/kathrin-analytics/server/.env"

      - name: Build and Start Containers
        run: |
          ssh -i ~/.ssh/deploy_key ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} 'set -e && cd /opt/apps/kathrin-analytics/server && echo "Building containers..." && docker compose -f docker-compose.production.yml down || true && docker compose -f docker-compose.production.yml up -d --build && docker image prune -f && echo "Container Status:" && docker ps --filter "name=kathrin" --format "table {{.Names}}\t{{.Status}}" && echo "Containers started!"'

      - name: Health Check
        run: |
          echo "â³ Waiting for services to start..."
          sleep 30

          # API Health Check
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://api-kathrin.91.99.177.238.nip.io/api/health || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… API is healthy! (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸ API returned HTTP $HTTP_CODE (may still be starting)"
          fi

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Analytics | https://analytics.91.99.177.238.nip.io |" >> $GITHUB_STEP_SUMMARY
          echo "| API | https://api-kathrin.91.99.177.238.nip.io |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

