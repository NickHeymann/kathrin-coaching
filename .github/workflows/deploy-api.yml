# Kathrin Coaching - API Deployment
# Automatisches Deployment bei Push auf main (server/ Ã„nderungen)

name: Deploy API to Hetzner

on:
  push:
    branches: [main]
    paths:
      - 'server/**'
      - '.github/workflows/deploy-api.yml'
  workflow_dispatch:

env:
  SERVER_HOST: 91.99.177.238
  SERVER_USER: root
  APP_PATH: /opt/apps/kathrin-analytics

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Clone or Update Repository on Server
        run: |
          ssh -i ~/.ssh/deploy_key ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} \
            'mkdir -p /opt/apps/kathrin-analytics && cd /opt/apps/kathrin-analytics && \
            if [ -d ".git" ]; then \
              git fetch origin main && git reset --hard origin/main; \
            else \
              rm -rf /opt/apps/kathrin-analytics/* 2>/dev/null || true && \
              rm -rf /opt/apps/kathrin-analytics/.* 2>/dev/null || true && \
              git clone --depth 1 https://github.com/NickHeymann/kathrin-coaching.git .; \
            fi'

      - name: Create Environment File
        run: |
          ssh -i ~/.ssh/deploy_key ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} \
            'echo "DB_PASSWORD=${{ secrets.KATHRIN_DB_PASSWORD }}" > /opt/apps/kathrin-analytics/server/.env && \
            echo "APP_SECRET=${{ secrets.KATHRIN_APP_SECRET }}" >> /opt/apps/kathrin-analytics/server/.env && \
            echo "API_SECRET_TOKEN=${{ secrets.KATHRIN_API_SECRET }}" >> /opt/apps/kathrin-analytics/server/.env && \
            echo "GITHUB_TOKEN=${{ secrets.KATHRIN_GITHUB_TOKEN }}" >> /opt/apps/kathrin-analytics/server/.env && \
            echo "GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}" >> /opt/apps/kathrin-analytics/server/.env && \
            echo "META_PIXEL_ID=${{ secrets.META_PIXEL_ID }}" >> /opt/apps/kathrin-analytics/server/.env && \
            echo "META_ACCESS_TOKEN=${{ secrets.META_ACCESS_TOKEN }}" >> /opt/apps/kathrin-analytics/server/.env && \
            echo "NODE_ENV=production" >> /opt/apps/kathrin-analytics/server/.env && \
            echo "PORT=3001" >> /opt/apps/kathrin-analytics/server/.env && \
            chmod 600 /opt/apps/kathrin-analytics/server/.env'

      - name: Build and Start Containers
        run: |
          ssh -i ~/.ssh/deploy_key ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} \
            'cd /opt/apps/kathrin-analytics/server && \
            docker compose -f docker-compose.production.yml down 2>/dev/null || true && \
            docker compose -f docker-compose.production.yml up -d --build && \
            docker image prune -f'

      - name: Health Check
        run: |
          echo "Waiting for services to start..."
          sleep 30
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://api-kathrin.91.99.177.238.nip.io/api/health || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "API is healthy (HTTP $HTTP_CODE)"
          else
            echo "API returned HTTP $HTTP_CODE (may still be starting)"
          fi

      - name: Show Container Status
        run: |
          ssh -i ~/.ssh/deploy_key ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} \
            'docker ps --filter "name=kathrin" --format "table {{.Names}}\t{{.Status}}"'

      - name: Deployment Summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Analytics | https://analytics.91.99.177.238.nip.io |" >> $GITHUB_STEP_SUMMARY
          echo "| API | https://api-kathrin.91.99.177.238.nip.io |" >> $GITHUB_STEP_SUMMARY
